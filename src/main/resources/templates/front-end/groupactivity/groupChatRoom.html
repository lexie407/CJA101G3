<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="'åœ˜éšŠèŠå¤©å®¤ - ' + ${act.actName}">åœ˜éšŠèŠå¤©å®¤</title>

    <th:block th:replace="~{/navTemplate :: headResources}"></th:block>
    <link rel="stylesheet" th:href="@{/css/light.css}" type="text/css" />
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css" />
    <!--    <link rel="stylesheet" th:href="@{/css/groupactivity/styleAct_front_enhanced.css}">-->
    <!-- GroupActivity æ¨¡çµ„ CSS -->
    <link
      rel="stylesheet"
      th:href="@{/css/groupactivity/styleAct_common.css}"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/groupactivity/groupactivity-chat.css}"
    />

    <!-- SockJS å’Œ STOMP åº« -->
    <script th:src="@{/webjars/sockjs-client/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/stomp.min.js}"></script>

    <!-- èŠå¤©å®¤æ¨£å¼å·²ç§»å‹•åˆ° groupactivity-chat.css -->
  </head>

  <body class="light">
    <div class="app-container">
      <div th:insert="~{/navTemplate :: navbar}"></div>
      <div class="main-content act-page">
        <div
          th:insert="~{/subnavActFrontGroup :: subnav('chat', ${act.actId})}"
        ></div>
        <main class="content-area-main act-area">
          <div class="act-chat-container">
            <!--            <a-->
            <!--              th:href="@{'/act/group/' + ${act.actId} + '/home'}"-->
            <!--              class="act-chat-back-link"-->
            <!--            >-->
            <!--              â† è¿”å›åœ˜éšŠä¸»é -->
            <!--            </a>-->

            <!-- èŠå¤©å®¤æ¨™é¡Œ -->
            <h1 class="act-chat-title" th:text="${act.actName} + ' èŠå¤©å®¤'">
              åœ˜éšŠèŠå¤©å®¤
            </h1>

            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div class="act-chat-status info" id="statusOutput">
              æ­£åœ¨é€£æ¥èŠå¤©å®¤...
            </div>

            <!-- èŠå¤©è¨Šæ¯å€åŸŸ -->
            <div id="messagesArea" class="act-chat-messages"></div>

            <!-- è¼¸å…¥å€åŸŸ -->
            <div class="act-chat-input-area">
              <input
                id="messageInput"
                type="text"
                placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯..."
                class="act-chat-message-input"
                disabled
              />
              <button
                id="sendBtn"
                onclick="sendMessage();"
                class="act-chat-send-btn"
                disabled
              >
                ç™¼é€
              </button>
              <button onclick="disconnect();" class="act-chat-disconnect-btn">
                é›¢é–‹
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script th:inline="javascript">
      /*
       * Spring WebSocket + STOMP èŠå¤©å®¤å‰ç«¯å¯¦ç¾
       * ä½¿ç”¨SockJSå’ŒSTOMPå”è­°é€²è¡Œå³æ™‚é€šè¨Š
       */

      // å¾ Thymeleaf ç²å–è³‡æ–™
      const actId = /*[[${act.actId}]]*/ 1;
      const actName = /*[[${act.actName}]]*/ "åœ˜éšŠæ´»å‹•";
      const currentMemberId = /*[[${currentMemberId}]]*/ 0;
      const currentMemberName = /*[[${currentMemberName}]]*/ "ç•¶å‰ç”¨æˆ¶";

      let stompClient = null; // STOMPå®¢æˆ¶ç«¯
      let isConnected = false; // é€£æ¥ç‹€æ…‹

      // ç•Œé¢å…ƒç´ 
      const statusOutput = document.getElementById("statusOutput");
      const messagesArea = document.getElementById("messagesArea");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");

      window.onload = function () {
        connect();
      }; // é é¢è¼‰å…¥æ™‚è‡ªå‹•é€£æ¥

      function connect() {
        updateStatus("æ­£åœ¨é€£æ¥...", "info");

        try {
          const socket = new SockJS("/ws"); // å»ºç«‹SockJSé€£æ¥
          stompClient = Stomp.over(socket);

          stompClient.connect(
            {},
            function (frame) {
              // é€£æ¥åˆ°STOMPæœå‹™å™¨
              isConnected = true;
              updateStatus("âœ… å·²é€£æ¥åˆ°èŠå¤©å®¤", "success");
              enableInputs(true);

              stompClient.subscribe(
                "/topic/public/" + actId,
                function (message) {
                  // è¨‚é–±åœ˜éšŠèŠå¤©é »é“
                  try {
                    const messageData = JSON.parse(message.body);
                    displayMessage(messageData);
                  } catch (e) {
                    console.error("è§£æè¨Šæ¯éŒ¯èª¤:", e);
                    addSystemMessage("æ”¶åˆ°ç„¡æ•ˆæ ¼å¼çš„è¨Šæ¯");
                  }
                }
              );

              stompClient.send(
                "/app/chat.addUser/" + actId,
                {},
                JSON.stringify({
                  // ç™¼é€åŠ å…¥èŠå¤©å®¤çš„è¨Šæ¯
                  userName: currentMemberName,
                  type: "JOIN",
                })
              );

              loadChatHistory(); // è¼‰å…¥æ­·å²èŠå¤©è¨˜éŒ„
            },
            function (error) {
              isConnected = false; // é€£æ¥éŒ¯èª¤è™•ç†
              enableInputs(false);
              updateStatus("âŒ é€£æ¥å¤±æ•—", "error");
              addSystemMessage("STOMP é€£æ¥éŒ¯èª¤: " + error);
              console.error("STOMP é€£æ¥éŒ¯èª¤:", error);
            }
          );
        } catch (e) {
          updateStatus("âŒ ç„¡æ³•å»ºç«‹é€£æ¥", "error");
          addSystemMessage("ç„¡æ³•å»ºç«‹ STOMP é€£æ¥: " + e.message);
          console.error("å»ºç«‹é€£æ¥éŒ¯èª¤:", e);
        }
      }

      function sendMessage() {
        if (!isConnected || !stompClient) {
          alert("å°šæœªé€£æ¥åˆ°èŠå¤©å®¤");
          return false;
        }

        const message = messageInput.value.trim();
        if (message === "") {
          alert("è«‹è¼¸å…¥è¨Šæ¯å…§å®¹");
          return false;
        }

        try {
          stompClient.send(
            "/app/chat.sendMessage/" + actId,
            {},
            JSON.stringify({
              // ç™¼é€è¨Šæ¯åˆ°STOMPç«¯é»
              message: message,
              userName: currentMemberName,
              actId: actId,
              memberId: currentMemberId,
              // memberId: 38,
              type: "CHAT",
            })
          );

          messageInput.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
          messageInput.blur();
          setTimeout(() => {
            messageInput.focus();
          }, 50);

          return true;
        } catch (e) {
          alert("ç™¼é€è¨Šæ¯å¤±æ•—: " + e.message);
          console.error("ç™¼é€è¨Šæ¯éŒ¯èª¤:", e);
          return false;
        }
      }

      function disconnect() {
        if (stompClient && isConnected) {
          stompClient.disconnect();
          isConnected = false;
          enableInputs(false);
          updateStatus("å·²æ–·é–‹é€£æ¥", "info");
        }
        window.location.href = "/act/group/" + actId + "/home"; // è¿”å›åœ˜éšŠä¸»é 
      }

      function updateStatus(message, type) {
        statusOutput.textContent = message;
        statusOutput.className = `chat-status ${type}`;
      }

      function enableInputs(enabled) {
        messageInput.disabled = !enabled;
        sendBtn.disabled = !enabled;
      }

      function displayMessage(messageData) {
        const messageContainer = document.createElement("div");
        messageContainer.style.marginBottom = "15px";
        messageContainer.style.display = "flex";
        messageContainer.style.width = "100%";

        const messageDiv = document.createElement("div");
        messageDiv.style.maxWidth = "70%";
        messageDiv.style.padding = "10px 15px";
        messageDiv.style.borderRadius = "18px";
        messageDiv.style.wordWrap = "break-word";
        messageDiv.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";

        if (
          messageData.type === "system" ||
          messageData.type === "join" ||
          messageData.type === "leave"
        ) {
          // ç³»çµ±è¨Šæ¯ç½®ä¸­ - ä½¿ç”¨ light.css é…è‰²
          messageContainer.style.justifyContent = "center";
          messageDiv.style.background =
            "var(--md-sys-color-tertiary-container)";
          messageDiv.style.color = "var(--md-sys-color-on-tertiary-container)";
          messageDiv.style.fontStyle = "italic";
          messageDiv.style.textAlign = "center";
          messageDiv.style.borderRadius = "12px";
          messageDiv.style.maxWidth = "80%";
          messageDiv.style.border =
            "1px solid var(--md-sys-color-outline-variant)";

          let icon = "ğŸ¤–";
          if (messageData.type === "join") icon = "ğŸ‘‹";
          if (messageData.type === "leave") icon = "ğŸ‘‹";

          messageDiv.innerHTML = `<strong>${icon} ç³»çµ±:</strong> ${
            messageData.message
          } <small style="color: var(--md-sys-color-on-tertiary-container); opacity: 0.7;">(${formatTime(
            messageData.timestamp
          )})</small>`;
        } else {
          // æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰ç”¨æˆ¶çš„è¨Šæ¯
          const isMyMessage = messageData.userName === currentMemberName;

          if (isMyMessage) {
            // è‡ªå·±çš„è¨Šæ¯ï¼šé å³ï¼Œä½¿ç”¨ä¸»è‰²ç³»
            messageContainer.style.justifyContent = "flex-end";
            messageDiv.style.background = "var(--md-sys-color-primary)";
            messageDiv.style.color = "var(--md-sys-color-on-primary)";
            messageDiv.style.border = "1px solid var(--md-sys-color-primary)";
            messageDiv.innerHTML = `
              <div style="margin-bottom: 3px; text-align: right;">
                <small style="color: var(--md-sys-color-on-primary); opacity: 0.8;">${formatTime(
                  messageData.timestamp
                )}</small>
              </div>
              <div>${messageData.message}</div>
            `;
          } else {
            // åˆ¥äººçš„è¨Šæ¯ï¼šé å·¦ï¼Œä½¿ç”¨æ¬¡è‰²ç³»
            messageContainer.style.justifyContent = "flex-start";
            messageDiv.style.background = "var(--md-sys-color-secondary)";
            messageDiv.style.color = "var(--md-sys-color-on-secondary)";
            messageDiv.style.border = "1px solid var(--md-sys-color-secondary)";
            messageDiv.innerHTML = `
              <div style="margin-bottom: 3px;">
                <strong style="color: var(--md-sys-color-on-secondary); opacity: 0.9;">${
                  messageData.userName
                }</strong>
                <small style="color: var(--md-sys-color-on-secondary); opacity: 0.8; margin-left: 8px;">${formatTime(
                  messageData.timestamp
                )}</small>
              </div>
              <div>${messageData.message}</div>
            `;
          }
        }

        messageContainer.appendChild(messageDiv);
        messagesArea.appendChild(messageContainer);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      function addSystemMessage(message) {
        const messageData = {
          type: "system",
          userName: "ç³»çµ±",
          message: message,
          timestamp: Date.now(),
        };
        displayMessage(messageData);
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
      }

      function loadChatHistory() {
        // è¼‰å…¥æ­·å²èŠå¤©è¨˜éŒ„
        fetch(`/act/group/${actId}/chat/history`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.messages && data.messages.length > 0) {
              // æ¸…ç©ºç¾æœ‰è¨Šæ¯å€åŸŸ
              messagesArea.innerHTML = "";

              // é¡¯ç¤ºè¼‰å…¥çš„æ­·å²è¨˜éŒ„
              data.messages.forEach((messageJson) => {
                try {
                  const messageData = JSON.parse(messageJson);
                  displayMessage(messageData);
                } catch (e) {
                  // éœé»˜è™•ç†è§£æéŒ¯èª¤
                }
              });

              addSystemMessage(`ğŸ“‹ å·²è¼‰å…¥ ${data.count} æ¢æ­·å²è¨Šæ¯`);
            } else {
              addSystemMessage(
                "ğŸ“ é€™æ˜¯ä¸€å€‹å…¨æ–°çš„èŠå¤©å®¤ï¼Œé–‹å§‹æ‚¨çš„ç¬¬ä¸€æ®µå°è©±å§ï¼"
              );
            }
          })
          .catch((error) => {
            addSystemMessage("âš ï¸ è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—ï¼Œä½†æ‚¨ä»å¯ä»¥æ­£å¸¸èŠå¤©");
            console.error("è¼‰å…¥æ­·å²è¨˜éŒ„éŒ¯èª¤:", error);
          });
      }

      // Enter éµç™¼é€è¨Šæ¯
      messageInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          setTimeout(() => {
            sendMessage();
          }, 10);
        }
      });

      // é é¢å¸è¼‰æ™‚æ–·é–‹é€£æ¥
      window.addEventListener("beforeunload", function () {
        if (stompClient && isConnected) {
          stompClient.disconnect();
        }
      });
    </script>
  </body>
</html>
