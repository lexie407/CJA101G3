<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="'åœ˜éšŠèŠå¤©å®¤ - ' + ${act.actName}">åœ˜éšŠèŠå¤©å®¤</title>

    <th:block th:replace="~{/navTemplate :: headResources}"></th:block>
    <link rel="stylesheet" th:href="@{/css/light.css}" type="text/css" />
    <link rel="stylesheet" th:href="@{/css/style.css}" type="text/css" />
    <!--    <link rel="stylesheet" th:href="@{/css/styleAct_front_enhanced.css}">-->

    <style>
      /* èŠå¤©å®¤æ¨£å¼ - ä½¿ç”¨ light.css é…è‰² */
      .chat-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: var(--md-sys-color-surface-container-lowest);
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--md-sys-color-outline-variant);
      }
      .chat-status {
        margin: 10px 0;
        padding: 12px 16px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        font-size: 14px;
      }
      .error {
        background: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
      }
      .success {
        background: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
      }
      .info {
        background: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: var(--md-sys-color-primary);
        text-decoration: none;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 8px;
        transition: background-color 0.2s ease;
      }
      .back-link:hover {
        background: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
        text-decoration: none;
      }

      /* èŠå¤©å®¤æ¨™é¡Œæ¨£å¼ */
      .chat-title {
        color: var(--md-sys-color-on-surface);
        margin-bottom: 16px;
        font-weight: 600;
      }

      /* èŠå¤©è¨Šæ¯å€åŸŸæ¨£å¼ */
      .messages-area {
        height: 400px;
        border: 2px solid var(--md-sys-color-outline-variant);
        border-radius: 12px;
        padding: 16px;
        overflow-y: auto;
        margin: 20px 0;
        background: var(--md-sys-color-surface);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      /* è¼¸å…¥å€åŸŸæ¨£å¼ */
      .input-area {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--md-sys-color-outline);
        border-radius: 24px;
        font-size: 14px;
        background: var(--md-sys-color-surface);
        color: var(--md-sys-color-on-surface);
        transition: border-color 0.2s ease;
      }

      .message-input:focus {
        outline: none;
        border-color: var(--md-sys-color-primary);
        box-shadow: 0 0 0 2px var(--md-sys-color-primary-container);
      }

      .message-input:disabled {
        background: var(--md-sys-color-surface-variant);
        color: var(--md-sys-color-on-surface-variant);
        border-color: var(--md-sys-color-outline-variant);
      }

      .send-btn {
        padding: 12px 20px;
        background: var(--md-sys-color-primary);
        color: var(--md-sys-color-on-primary);
        border: none;
        border-radius: 20px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
      }

      .send-btn:hover:not(:disabled) {
        background: var(--md-sys-color-primary);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(41, 171, 194, 0.3);
      }

      .send-btn:disabled {
        background: var(--md-sys-color-surface-variant);
        color: var(--md-sys-color-on-surface-variant);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .disconnect-btn {
        padding: 12px 20px;
        background: var(--md-sys-color-error);
        color: var(--md-sys-color-on-error);
        border: none;
        border-radius: 20px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
      }

      .disconnect-btn:hover {
        background: var(--md-sys-color-error);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(186, 26, 26, 0.3);
      }
    </style>
  </head>

  <body class="light">
    <div class="app-container">
      <div th:insert="~{/navTemplate :: navbar}"></div>
      <div class="main-content act-page">
        <div
          th:insert="~{/subnavActFrontGroup :: subnav('chat', ${act.actId})}"
        ></div>
        <main class="content-area-main act-area">
          <div class="chat-container">
<!--            <a-->
<!--              th:href="@{'/act/group/' + ${act.actId} + '/home'}"-->
<!--              class="back-link"-->
<!--            >-->
<!--              â† è¿”å›åœ˜éšŠä¸»é -->
<!--            </a>-->

            <!-- èŠå¤©å®¤æ¨™é¡Œ -->
            <h1 class="chat-title" th:text="${act.actName} + ' èŠå¤©å®¤'">
              åœ˜éšŠèŠå¤©å®¤
            </h1>

            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div class="chat-status info" id="statusOutput">
              æ­£åœ¨é€£æ¥èŠå¤©å®¤...
            </div>

            <!-- èŠå¤©è¨Šæ¯å€åŸŸ -->
            <div id="messagesArea" class="messages-area"></div>

            <!-- è¼¸å…¥å€åŸŸ -->
            <div class="input-area">
              <input
                id="messageInput"
                type="text"
                placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯..."
                class="message-input"
                disabled
              />
              <button
                id="sendBtn"
                onclick="sendMessage();"
                class="send-btn"
                disabled
              >
                ç™¼é€
              </button>
              <button onclick="disconnect();" class="disconnect-btn">
                é›¢é–‹
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script th:inline="javascript">
      // å¾ Thymeleaf ç²å–è³‡æ–™
      const actNo = /*[[${act.actId}]]*/ 1;
      const actName = /*[[${act.actName}]]*/ "åœ˜éšŠæ´»å‹•";
      const currentMemberId = /*[[${currentMemberId}]]*/ 0;
      const currentMemberName = /*[[${currentMemberName}]]*/ "ç•¶å‰ç”¨æˆ¶";

      // æ§‹é€  WebSocket URL
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const host = window.location.host;
      const endPointURL = `${protocol}//${host}/groupchat/${actNo}`;

      let webSocket;
      let isConnected = false;

      // ç•Œé¢å…ƒç´ 
      const statusOutput = document.getElementById("statusOutput");
      const messagesArea = document.getElementById("messagesArea");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");

      // é é¢è¼‰å…¥æ™‚è‡ªå‹•é€£æ¥
      window.onload = function () {
        connect();
      };

      function connect() {
        updateStatus("æ­£åœ¨é€£æ¥...", "info");

        try {
          webSocket = new WebSocket(endPointURL);

          webSocket.onopen = function (event) {
            isConnected = true;
            updateStatus("âœ… å·²é€£æ¥åˆ°èŠå¤©å®¤", "success");
            enableInputs(true);
            loadChatHistory();
          };

          webSocket.onmessage = function (event) {
            try {
              const messageData = JSON.parse(event.data);
              displayMessage(messageData);
            } catch (e) {
              addSystemMessage("æ”¶åˆ°ç„¡æ•ˆæ ¼å¼çš„è¨Šæ¯");
            }
          };

          webSocket.onclose = function (event) {
            isConnected = false;
            enableInputs(false);

            let message = `âŒ é€£æ¥å·²é—œé–‰ (${event.code})`;
            if (event.reason) message += ` - ${event.reason}`;

            updateStatus(message, "error");
            addSystemMessage(
              `é€£æ¥é—œé–‰: ${event.code} - ${event.reason || "æœªçŸ¥åŸå› "}`
            );
          };

          webSocket.onerror = function (error) {
            updateStatus("âŒ é€£æ¥éŒ¯èª¤", "error");
            addSystemMessage("WebSocket é€£æ¥ç™¼ç”ŸéŒ¯èª¤");
          };
        } catch (e) {
          updateStatus("âŒ ç„¡æ³•å»ºç«‹é€£æ¥", "error");
          addSystemMessage("ç„¡æ³•å»ºç«‹ WebSocket é€£æ¥: " + e.message);
        }
      }

      function sendMessage() {
        if (!isConnected) {
          alert("å°šæœªé€£æ¥åˆ°èŠå¤©å®¤");
          return false;
        }

        const message = messageInput.value.trim();
        if (message === "") {
          alert("è«‹è¼¸å…¥è¨Šæ¯å…§å®¹");
          return false;
        }

        try {
          const messageObj = { message: message };
          webSocket.send(JSON.stringify(messageObj));

          // ç¢ºä¿è¼¸å…¥æ¡†è¢«æ¸…ç©º
          messageInput.value = "";
          messageInput.blur();
          setTimeout(() => {
            messageInput.focus();
          }, 50);

          return true;
        } catch (e) {
          alert("ç™¼é€è¨Šæ¯å¤±æ•—: " + e.message);
          return false;
        }
      }

      function disconnect() {
        if (webSocket && isConnected) {
          webSocket.close();
        }
      }

      function updateStatus(message, type) {
        statusOutput.textContent = message;
        statusOutput.className = `chat-status ${type}`;
      }

      function enableInputs(enabled) {
        messageInput.disabled = !enabled;
        sendBtn.disabled = !enabled;
      }

      function displayMessage(messageData) {
        const messageContainer = document.createElement("div");
        messageContainer.style.marginBottom = "15px";
        messageContainer.style.display = "flex";
        messageContainer.style.width = "100%";

        const messageDiv = document.createElement("div");
        messageDiv.style.maxWidth = "70%";
        messageDiv.style.padding = "10px 15px";
        messageDiv.style.borderRadius = "18px";
        messageDiv.style.wordWrap = "break-word";
        messageDiv.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";

        if (messageData.type === "system") {
          // ç³»çµ±è¨Šæ¯ç½®ä¸­ - ä½¿ç”¨ light.css é…è‰²
          messageContainer.style.justifyContent = "center";
          messageDiv.style.background =
            "var(--md-sys-color-tertiary-container)";
          messageDiv.style.color = "var(--md-sys-color-on-tertiary-container)";
          messageDiv.style.fontStyle = "italic";
          messageDiv.style.textAlign = "center";
          messageDiv.style.borderRadius = "12px";
          messageDiv.style.maxWidth = "80%";
          messageDiv.style.border =
            "1px solid var(--md-sys-color-outline-variant)";
          messageDiv.innerHTML = `<strong>ğŸ¤– ç³»çµ±:</strong> ${
            messageData.message
          } <small style="color: var(--md-sys-color-on-tertiary-container); opacity: 0.7;">(${formatTime(
            messageData.timestamp
          )})</small>`;
        } else {
          // æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰ç”¨æˆ¶çš„è¨Šæ¯
          const isMyMessage = messageData.userName === currentMemberName;

          if (isMyMessage) {
            // è‡ªå·±çš„è¨Šæ¯ï¼šé å³ï¼Œä½¿ç”¨ä¸»è‰²ç³»
            messageContainer.style.justifyContent = "flex-end";
            messageDiv.style.background = "var(--md-sys-color-primary)";
            messageDiv.style.color = "var(--md-sys-color-on-primary)";
            messageDiv.style.border = "1px solid var(--md-sys-color-primary)";
            messageDiv.innerHTML = `
              <div style="margin-bottom: 3px; text-align: right;">
                <small style="color: var(--md-sys-color-on-primary); opacity: 0.8;">${formatTime(
                  messageData.timestamp
                )}</small>
              </div>
              <div>${messageData.message}</div>
            `;
          } else {
            // åˆ¥äººçš„è¨Šæ¯ï¼šé å·¦ï¼Œä½¿ç”¨æ¬¡è‰²ç³»
            messageContainer.style.justifyContent = "flex-start";
            messageDiv.style.background = "var(--md-sys-color-secondary)";
            messageDiv.style.color = "var(--md-sys-color-on-secondary)";
            messageDiv.style.border = "1px solid var(--md-sys-color-secondary)";
            messageDiv.innerHTML = `
              <div style="margin-bottom: 3px;">
                <strong style="color: var(--md-sys-color-on-secondary); opacity: 0.9;">${
                  messageData.userName
                }</strong>
                <small style="color: var(--md-sys-color-on-secondary); opacity: 0.8; margin-left: 8px;">${formatTime(
                  messageData.timestamp
                )}</small>
              </div>
              <div>${messageData.message}</div>
            `;
          }
        }

        messageContainer.appendChild(messageDiv);
        messagesArea.appendChild(messageContainer);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      function addSystemMessage(message) {
        const messageData = {
          type: "system",
          userName: "ç³»çµ±",
          message: message,
          timestamp: Date.now(),
        };
        displayMessage(messageData);
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
      }

      // è¼‰å…¥æ­·å²èŠå¤©è¨˜éŒ„
      function loadChatHistory() {
        fetch(`/act/group/${actNo}/chat/history`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.messages && data.messages.length > 0) {
              // æ¸…ç©ºç¾æœ‰è¨Šæ¯å€åŸŸ
              messagesArea.innerHTML = "";

              // é¡¯ç¤ºè¼‰å…¥çš„æ­·å²è¨˜éŒ„
              data.messages.forEach((messageJson) => {
                try {
                  const messageData = JSON.parse(messageJson);
                  displayMessage(messageData);
                } catch (e) {
                  // éœé»˜è™•ç†è§£æéŒ¯èª¤
                }
              });

              addSystemMessage(`ğŸ“‹ å·²è¼‰å…¥ ${data.count} æ¢æ­·å²è¨Šæ¯`);
            } else {
              addSystemMessage(
                "ğŸ“ é€™æ˜¯ä¸€å€‹å…¨æ–°çš„èŠå¤©å®¤ï¼Œé–‹å§‹æ‚¨çš„ç¬¬ä¸€æ®µå°è©±å§ï¼"
              );
            }
          })
          .catch((error) => {
            addSystemMessage("âš ï¸ è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—ï¼Œä½†æ‚¨ä»å¯ä»¥æ­£å¸¸èŠå¤©");
          });
      }

      // Enter éµç™¼é€è¨Šæ¯
      messageInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          setTimeout(() => {
            sendMessage();
          }, 10);
        }
      });
    </script>
  </body>
</html>
