<!DOCTYPE html>
<html lang="ZH-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è³‡æ–™ä¿®æ”¹ | å¾Œå° | å³¶éŠkha</title>
    <th:block th:replace="~{/navBackTemplate :: headResources}"></th:block>
    <!--å¾Œå°CSS-->
    <link rel="stylesheet" th:href="@{/css/light.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link th:href="@{/vendors/quillEditor/quill.snow.css}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        .input-readonly[readonly] {
            background-color: var(--md-sys-color-surface-container); /* èƒŒæ™¯å¾®ç° */
            color: var(--md-sys-color-outline); /* å­—è‰²æ·¡ç° */
            cursor: not-allowed; /* æ»‘é¼ ç¦æ­¢ */
            border: 1px solid var(--md-sys-color-outline-variant); /* é‚Šæ¡†æ·¡ç° */
            padding: 10px;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .article-edit-form {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--md-sys-color-surface-container-lowest);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .article-edit-form .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .article-edit-form .form-group label {
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .article-edit-form .form-group input,
        .article-edit-form .form-group select {
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 6px;
            font-size: 16px;
            /*background-color: var(--md-sys-color-surface-container-highest);*/
            color: var(--md-sys-color-on-surface);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
        }

        .article-edit-form .form-group input:focus,
        .article-edit-form .form-group select:focus {
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px var(--md-sys-color-primary-container);
            outline: none;
        }

        .article-edit-form .form-group .error {
            color: var(--md-sys-color-error);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Quill ç·¨è¼¯å™¨åŒ…è£å€å¡Š */
        .quill-editor {
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 6px;
            background-color: var(--md-sys-color-surface);
            padding: 0; /* å¤–å±¤ä¸è¦é¡å¤– paddingï¼Œäº¤çµ¦ .ql-editor */
            box-sizing: border-box;
        }

        .article-edit-form .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 30px;
            gap: 12px;
        }

        .material-button.secondary-btn {
            background-color: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .material-button.secondary-btn:hover {
            background-color: var(--md-sys-color-secondary-fixed-dim);
        }


        /* çœŸæ­£çš„ç·¨è¼¯å€ */
        .quill-editor .ql-editor {
            min-height: 200px;
            padding: 12px;
            background-color: transparent;
            box-sizing: border-box;
        }

        /* è¡¨å–®æ¨™é¡Œ */
        .form-artTitle {
            font-size: 24px;
            font-weight: bold;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            padding-bottom: 10px;
            text-align: center;
        }

        /* ç•™è¨€ç®¡ç†å€å¡Šæ©«å‘æ’åˆ— */
        #comments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .comment-block {
            display: flex;
            flex-direction: row;
            align-items: center;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            background: #fafbfc;
            gap: 32px;
        }
        .comment-block .comment-info {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 32px;
            flex-wrap: wrap;
        }
        .comment-block .comment-info > div {
            min-width: 120px;
            margin-bottom: 4px;
        }
        .comment-block .comment-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 90px;
        }

        /* ç•™è¨€ç®¡ç†å€å¡Šè¡¨æ ¼æ¨£å¼ */
        #comments-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: #fafbfc;
        }
        #comments-table th, #comments-table td {
            border: 1px solid #ccc;
            padding: 8px 10px;
            text-align: center;
            font-size: 15px;
        }
        #comments-table th {
            background: #f0f1f3;
            font-weight: bold;
        }
        #comments-table td .material-button {
            margin: 0 2px;
        }
    </style>
</head>
<body class="light">
<div class="app-container">
    <!--å¾Œå°:å´é‚Šæ””ï¼Œé€šç”¨æ¨£å¼ï¼Œä¸ç”¨æ”¹-->
    <div th:insert="~{/navBackTemplate :: navbar}"></div>

    <div class="main-content">
        <!--å‰å°:é ‚éƒ¨æ¬¡å°è¦½:å„æ¨¡çµ„è¤‡è£½subnavXxx.htmlæ”¹å¥½å¾Œï¼Œä¿®æ­£ä¸‹é¢ç‚ºsubnavæ¨¡çµ„å :: subnav('æ¨¡æ¿çš„è¦é»äº®çš„key')ï¼Œ-->
        <div th:insert="~{back-end/forum/subnavForum :: subnav('all')}"></div>

        <!--main ä»¥ä¸‹ç‚ºé é¢ä¸»è¦å…§å®¹ -->
        <main class="content-area-main">
            <div style="margin-bottom: 1rem;">
                <button type="button" class="material-button" onclick="history.back()" style="display: flex; align-items: center;">
                    <span class="material-icons" style="margin-right: 6px;">arrow_back</span>è¿”å›
                </button>
            </div>
<!--            <h3><a class="navbar-brand" th:href="@{/forum/admin/selectPage}">å‰å¾€æ–‡ç« æŸ¥è©¢</a></h3>-->
            <h2 class="form-title">ğŸ“ ç·¨è¼¯æ–‡ç« </h2>

            <!--    æ–‡ç« ç·¨è¼¯è¡¨å–®      -->
            <form class="article-edit-form" th:action="@{/forum/admin/update}" method="post" th:object="${articleForm}" enctype="multipart/form-data">
                <!-- æ–‡ç« ç·¨è™Ÿ -->
                <div class="form-group half">
                    <label for="artId">æ–‡ç« ç·¨è™Ÿ</label>
                    <input id="artId" type="text" th:field="*{artId}" class="input-readonly" readonly />
                </div>

                <!-- æ–‡ç« æ¨™é¡Œ -->
                <div class="form-group half">
                    <label for="artTitle">æ–‡ç« æ¨™é¡Œ</label>
                    <input type="text" id="artTitle" th:field="*{artTitle}" required />
                    <span th:if="${#fields.hasErrors('artTitle')}" th:errors="*{artTitle}" class="error"
                          id="artTitle.errors"></span>
                </div>
                

                <!-- æ–‡ç« é¡åˆ¥ -->
                <div class="form-group">
                    <label for="artCat">æ–‡ç« é¡åˆ¥</label>
                    <select id="artCat" th:field="*{artCat}" required>
                        <option value="1">æ–‡ç« </option>
                        <option value="2">å•é¡Œ</option>
                        <option value="3">å·²è§£æ±º</option>
                    </select>
                </div>

                <!-- æœƒå“¡ç·¨è™Ÿï¼ˆå”¯è®€ï¼‰ -->
                <div class="form-group">
                    <label for="artHol">æœƒå“¡ç·¨è™Ÿ</label>
                    <input type="number" id="artHol" th:field="*{artHol}" class="input-readonly" readonly />
                    <span th:if="${#fields.hasErrors('artHol')}" th:errors="*{artHol}" class="error" id="artHol.errors"></span>
                </div>

                <!-- ä¸Šä¸‹æ¶ç‹€æ…‹ -->
                <div class="form-group">
                    <label for="artSta">ç‹€æ…‹</label>
                    <select id="artSta" th:field="*{artSta}" required>
                        <option value="1">ä¸Šæ¶</option>
                        <option value="2">ä¸‹æ¶</option>
                    </select>
                </div>

                <!-- æ–‡ç« å…§å®¹ -->
                <div class="form-group full-width">
                    <label for="editor">æ–‡ç« å…§å®¹</label>
                    <textarea id="artCon" th:field="*{artCon}" style="display:none;"></textarea>
                    <div id="editor" class="quill-editor">
                        <div th:utext="*{artCon}"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="material-button" onclick="history.back()">å–æ¶ˆ</button>
                    <button type="submit" class="material-button secondary-btn">é€å‡º</button>
                </div>

            </form>

            <div id="editor2">
                <!--Qillç·¨è¼¯å™¨-->
            </div>

            <!-- ====== ç•™è¨€ç®¡ç†å€å¡Š ====== -->
            <div id="comment-manage-block" style="margin-top:40px;">
                <h3>ç•™è¨€ç®¡ç†</h3>
                <div id="comments-list">
                    <!-- é€™è£¡æœƒç”¨JSè¼‰å…¥ç•™è¨€è¡¨æ ¼ -->
                </div>
            </div>
            <!-- ===================================================================== -->

        </main>
    </div>
</div>

<script>
    // éš±è—éŒ¯èª¤è¨Šæ¯ç”¨
    function hideContent(d) {
        document.getElementById(d).style.display = "none";
    }

    // è¡¨å–®é€å‡ºæ™‚ï¼ŒæŠŠ Quill çš„ HTML å…§å®¹å¡«åˆ°éš±è—çš„ textarea
    document.querySelector('form').addEventListener('submit', function (e) {
        const html = quill.root.innerHTML;
        document.querySelector('#artCon').value = html;
    });

    // é¿å…ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ Quill æ˜¯ç©ºçš„
    window.addEventListener('DOMContentLoaded', () => {
        const initialContent = document.querySelector('#artCon').value;
        quill.root.innerHTML = initialContent;
    });

    const contextPath = getFullContextPath(); // ç²å–å®Œæ•´çš„ä¸Šä¸‹æ–‡è·¯å¾‘
    // å–å¾— host + context path
    function getFullContextPath() {

        const path = window.location.pathname;
        const firstSlash = path.indexOf("/", 1);
        const ctx = firstSlash === -1 ? "" : path.substring(0, firstSlash);
        return window.location.origin + ctx;
    }


    // ====== ç•™è¨€ç®¡ç†å€å¡ŠAJAXè¼‰å…¥ ======
    document.addEventListener('DOMContentLoaded', function () {
        const artId = document.getElementById('artId').value;
        fetch(`/commentsAPI/getComments`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'commArt=' + encodeURIComponent(artId)
        })
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('comments-list');
            if (!data || data.length === 0) {
                list.innerHTML = '<div style="color:#888;">ç›®å‰æ²’æœ‰ç•™è¨€ã€‚</div>';
                return;
            }
            let html = `
                <table id="comments-table">
                    <thead>
                        <tr>
<!--                            <th>ç•™è¨€ç·¨è™Ÿ</th>-->
                            <th>æœƒå“¡</th>
                            <th>ç•™è¨€é¡åˆ¥</th>
                            <th>å…§å®¹</th>
                            <th>åœ–ç‰‡</th>
                            <th>æ™‚é–“</th>
                            <th>ç•™è¨€ç‹€æ…‹</th>
                            <th>ç®¡ç†</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach(comm => {
                html += `
                    <tr>
<!--                        <td>${comm.commId}</td>-->
                        <td>${comm.commHol}</td>
                        <td>${comm.commCat === 1 ? 'æ–‡ç« ç•™è¨€' : comm.commCat === 2 ? 'å•é¡Œå›ç­”' : comm.commSta}</td>
<!--                        TODO: ç•™è¨€åœ–ç‰‡é¡¯ç¤º-->
                        <td>${comm.commCon}</td>
                        <td>${comm.commImg == null ? 'æ²’æœ‰åœ–ç‰‡' : comm.commImg}</td>
                        <td>${comm.commCreTime ? comm.commCreTime.replace('T', ' ').substring(0, 19) : ''}</td>
                        <td>${comm.commSta === 1 ? 'ä¸Šæ¶' : comm.commSta === 2 ? 'ä¸‹æ¶' : comm.commSta === 3 ? 'æœ€ä½³è§£' : comm.commSta}</td>
                        <td>
                            <button class="material-button" onclick="deleteComment(${comm.commId})" ${comm.commSta !== 1 ? 'disabled' : ''}>åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
            list.innerHTML = html;
        });
    });

    function deleteComment(commId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€ï¼Ÿ')) return;
        fetch(`/commentsAPI/deleteComments`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'commId=' + encodeURIComponent(commId)
        }).then(() => location.reload());
    }


</script>

<!-- å¼•ç”¨Quillç·¨è¼¯å™¨-->
<script th:src="@{/vendors/quillEditor/quilljs.js}"></script>
<script>
    const quill = new Quill('#editor', {
        modules: {
            toolbar: [
                [{'size': ['small', false, 'large', 'huge']}, 'bold', 'italic', 'underline', 'strike', 'blockquote'],        // toggled buttons
                ['link', 'image', 'video'],

                [{'list': 'ordered'}, {'list': 'bullet'}, {'list': 'check'}],
                [{'direction': 'rtl'}],                         // text direction

                [{'header': [1, 2, 3, 4, 5, 6, false]}],

                [{'color': []}, {'background': []}],          // dropdown with defaults from theme
                [{'align': []}],

                ['clean']                                         // remove formatting button
            ],
        },
        placeholder: 'ä¾†å¯«é»ä»€éº¼å§â€¦â€¦',
        theme: 'snow', // or 'bubble'
    });


</script>

</body>
</html>